============================= test session starts =============================
platform win32 -- Python 3.13.12, pytest-9.0.2, pluggy-1.6.0
rootdir: C:\Users\inanb\Desktop\SaveLinks
plugins: anyio-4.12.1
collected 9 items

tests\test_security.py ....                                              [ 44%]
tests\test_service.py FFFFF                                              [100%]

================================== FAILURES ===================================
_____________________________ test_register_login _____________________________

self = <src.database.repository.LinkRepository object at 0x00000226A2C85E80>
username = 'testuser'
salt = b" \xff\xe4\xa1\xd4#\xc2\xaco'\xaf\xfa\xfc\x85$\xfd"
verifier = b'\x0b\xc3\x1ft\x15\x05K\xd2\x93Dx\xd7\xde/\xefi]pq\x07#\xdb\xefe\xa0\x92\x7f/\xdaZ?\xe8'

    def add_user(self, username: str, salt: bytes, verifier: bytes) -> int:
        """Adds a new user to the database."""
        try:
            with self._get_connection() as conn:
                cursor = conn.cursor()
>               cursor.execute(
                    "INSERT INTO users (username, salt, verifier) VALUES (?, ?, ?)",
                    (username, salt, verifier)
                )
E               sqlite3.OperationalError: no such table: users

src\database\repository.py:58: OperationalError

The above exception was the direct cause of the following exception:

self = <src.service.link_service.LinkService object at 0x00000226A2C85D30>
username = 'testuser', password = 'password123'

    def register_user(self, username, password):
        """Registers a new user."""
        if not username or not password:
            raise ValidationError("Username and password cannot be empty.")
    
        salt = SecurityManager.generate_salt()
        key = SecurityManager.derive_key(password, salt)
        verifier = SecurityManager.hash_key(key)
    
        try:
>           self.repository.add_user(username, salt, verifier)

src\service\link_service.py:22: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <src.database.repository.LinkRepository object at 0x00000226A2C85E80>
username = 'testuser'
salt = b" \xff\xe4\xa1\xd4#\xc2\xaco'\xaf\xfa\xfc\x85$\xfd"
verifier = b'\x0b\xc3\x1ft\x15\x05K\xd2\x93Dx\xd7\xde/\xefi]pq\x07#\xdb\xefe\xa0\x92\x7f/\xdaZ?\xe8'

    def add_user(self, username: str, salt: bytes, verifier: bytes) -> int:
        """Adds a new user to the database."""
        try:
            with self._get_connection() as conn:
                cursor = conn.cursor()
                cursor.execute(
                    "INSERT INTO users (username, salt, verifier) VALUES (?, ?, ?)",
                    (username, salt, verifier)
                )
                conn.commit()
                return cursor.lastrowid
        except sqlite3.IntegrityError:
            raise DatabaseError("User already exists.")
        except sqlite3.Error as e:
            logger.error(f"Failed to add user: {e}")
>           raise DatabaseError("Failed to add user.") from e
E           src.core.exceptions.DatabaseError: Failed to add user.

src\database\repository.py:68: DatabaseError

During handling of the above exception, another exception occurred:

service = <src.service.link_service.LinkService object at 0x00000226A2C85D30>

    def test_register_login(service):
        username = "testuser"
        password = "password123"
    
        # Register
>       assert service.register_user(username, password) is True
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\test_service.py:18: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <src.service.link_service.LinkService object at 0x00000226A2C85D30>
username = 'testuser', password = 'password123'

    def register_user(self, username, password):
        """Registers a new user."""
        if not username or not password:
            raise ValidationError("Username and password cannot be empty.")
    
        salt = SecurityManager.generate_salt()
        key = SecurityManager.derive_key(password, salt)
        verifier = SecurityManager.hash_key(key)
    
        try:
            self.repository.add_user(username, salt, verifier)
            logger.info(f"User '{username}' registered successfully.")
            return True
        except Exception as e:
            logger.error(f"Registration failed for user '{username}': {e}")
>           raise SaveLinksError("Registration failed. Username might be taken.")
E           src.core.exceptions.SaveLinksError: Registration failed. Username might be taken.

src\service\link_service.py:27: SaveLinksError
---------------------------- Captured stderr call -----------------------------
2026-02-11 20:03:46,935 - SaveLinks - ERROR - Failed to add user: no such table: users
2026-02-11 20:03:46,935 - SaveLinks - ERROR - Registration failed for user 'testuser': Failed to add user.
------------------------------ Captured log call ------------------------------
ERROR    SaveLinks:repository.py:67 Failed to add user: no such table: users
ERROR    SaveLinks:link_service.py:26 Registration failed for user 'testuser': Failed to add user.
_________________________ test_login_invalid_password _________________________

self = <src.database.repository.LinkRepository object at 0x00000226A2C75950>
username = 'user2', salt = b'\x03_\xb1\ns\xcc\xbd8%I\xaa\x8d\xdd\xfc\xc4&'
verifier = b'e\xcf\xc0\xb0{ \x16\xb3*e\x9dt\x7f\xce\x86\x1b~\xe6X\x02\x8e\xb1\x16N\xc8o\r\x90\xdd\x04\xe6\xc6'

    def add_user(self, username: str, salt: bytes, verifier: bytes) -> int:
        """Adds a new user to the database."""
        try:
            with self._get_connection() as conn:
                cursor = conn.cursor()
>               cursor.execute(
                    "INSERT INTO users (username, salt, verifier) VALUES (?, ?, ?)",
                    (username, salt, verifier)
                )
E               sqlite3.OperationalError: no such table: users

src\database\repository.py:58: OperationalError

The above exception was the direct cause of the following exception:

self = <src.service.link_service.LinkService object at 0x00000226A2C75810>
username = 'user2', password = 'pass'

    def register_user(self, username, password):
        """Registers a new user."""
        if not username or not password:
            raise ValidationError("Username and password cannot be empty.")
    
        salt = SecurityManager.generate_salt()
        key = SecurityManager.derive_key(password, salt)
        verifier = SecurityManager.hash_key(key)
    
        try:
>           self.repository.add_user(username, salt, verifier)

src\service\link_service.py:22: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <src.database.repository.LinkRepository object at 0x00000226A2C75950>
username = 'user2', salt = b'\x03_\xb1\ns\xcc\xbd8%I\xaa\x8d\xdd\xfc\xc4&'
verifier = b'e\xcf\xc0\xb0{ \x16\xb3*e\x9dt\x7f\xce\x86\x1b~\xe6X\x02\x8e\xb1\x16N\xc8o\r\x90\xdd\x04\xe6\xc6'

    def add_user(self, username: str, salt: bytes, verifier: bytes) -> int:
        """Adds a new user to the database."""
        try:
            with self._get_connection() as conn:
                cursor = conn.cursor()
                cursor.execute(
                    "INSERT INTO users (username, salt, verifier) VALUES (?, ?, ?)",
                    (username, salt, verifier)
                )
                conn.commit()
                return cursor.lastrowid
        except sqlite3.IntegrityError:
            raise DatabaseError("User already exists.")
        except sqlite3.Error as e:
            logger.error(f"Failed to add user: {e}")
>           raise DatabaseError("Failed to add user.") from e
E           src.core.exceptions.DatabaseError: Failed to add user.

src\database\repository.py:68: DatabaseError

During handling of the above exception, another exception occurred:

service = <src.service.link_service.LinkService object at 0x00000226A2C75810>

    def test_login_invalid_password(service):
>       service.register_user("user2", "pass")

tests\test_service.py:26: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <src.service.link_service.LinkService object at 0x00000226A2C75810>
username = 'user2', password = 'pass'

    def register_user(self, username, password):
        """Registers a new user."""
        if not username or not password:
            raise ValidationError("Username and password cannot be empty.")
    
        salt = SecurityManager.generate_salt()
        key = SecurityManager.derive_key(password, salt)
        verifier = SecurityManager.hash_key(key)
    
        try:
            self.repository.add_user(username, salt, verifier)
            logger.info(f"User '{username}' registered successfully.")
            return True
        except Exception as e:
            logger.error(f"Registration failed for user '{username}': {e}")
>           raise SaveLinksError("Registration failed. Username might be taken.")
E           src.core.exceptions.SaveLinksError: Registration failed. Username might be taken.

src\service\link_service.py:27: SaveLinksError
---------------------------- Captured stderr call -----------------------------
2026-02-11 20:03:46,994 - SaveLinks - ERROR - Failed to add user: no such table: users
2026-02-11 20:03:46,994 - SaveLinks - ERROR - Registration failed for user 'user2': Failed to add user.
------------------------------ Captured log call ------------------------------
ERROR    SaveLinks:repository.py:67 Failed to add user: no such table: users
ERROR    SaveLinks:link_service.py:26 Registration failed for user 'user2': Failed to add user.
____________________________ test_add_search_link _____________________________

self = <src.database.repository.LinkRepository object at 0x00000226A2C76710>
username = 'user3', salt = b'\xd3F\n4\xba\xb8+G\x86\xcf\xc3A\xb9S\x85\xef'
verifier = b"\\\xdf;'\xdf\x81\x96\x00\\t\xf0}6\xb5\xe4yp}\x18\x86+\xf3\xf0H\xde\xa1\xec}\xf7\xc8\x04\x14"

    def add_user(self, username: str, salt: bytes, verifier: bytes) -> int:
        """Adds a new user to the database."""
        try:
            with self._get_connection() as conn:
                cursor = conn.cursor()
>               cursor.execute(
                    "INSERT INTO users (username, salt, verifier) VALUES (?, ?, ?)",
                    (username, salt, verifier)
                )
E               sqlite3.OperationalError: no such table: users

src\database\repository.py:58: OperationalError

The above exception was the direct cause of the following exception:

self = <src.service.link_service.LinkService object at 0x00000226A2C76850>
username = 'user3', password = 'pass'

    def register_user(self, username, password):
        """Registers a new user."""
        if not username or not password:
            raise ValidationError("Username and password cannot be empty.")
    
        salt = SecurityManager.generate_salt()
        key = SecurityManager.derive_key(password, salt)
        verifier = SecurityManager.hash_key(key)
    
        try:
>           self.repository.add_user(username, salt, verifier)

src\service\link_service.py:22: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <src.database.repository.LinkRepository object at 0x00000226A2C76710>
username = 'user3', salt = b'\xd3F\n4\xba\xb8+G\x86\xcf\xc3A\xb9S\x85\xef'
verifier = b"\\\xdf;'\xdf\x81\x96\x00\\t\xf0}6\xb5\xe4yp}\x18\x86+\xf3\xf0H\xde\xa1\xec}\xf7\xc8\x04\x14"

    def add_user(self, username: str, salt: bytes, verifier: bytes) -> int:
        """Adds a new user to the database."""
        try:
            with self._get_connection() as conn:
                cursor = conn.cursor()
                cursor.execute(
                    "INSERT INTO users (username, salt, verifier) VALUES (?, ?, ?)",
                    (username, salt, verifier)
                )
                conn.commit()
                return cursor.lastrowid
        except sqlite3.IntegrityError:
            raise DatabaseError("User already exists.")
        except sqlite3.Error as e:
            logger.error(f"Failed to add user: {e}")
>           raise DatabaseError("Failed to add user.") from e
E           src.core.exceptions.DatabaseError: Failed to add user.

src\database\repository.py:68: DatabaseError

During handling of the above exception, another exception occurred:

service = <src.service.link_service.LinkService object at 0x00000226A2C76850>

    def test_add_search_link(service):
>       service.register_user("user3", "pass")

tests\test_service.py:31: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <src.service.link_service.LinkService object at 0x00000226A2C76850>
username = 'user3', password = 'pass'

    def register_user(self, username, password):
        """Registers a new user."""
        if not username or not password:
            raise ValidationError("Username and password cannot be empty.")
    
        salt = SecurityManager.generate_salt()
        key = SecurityManager.derive_key(password, salt)
        verifier = SecurityManager.hash_key(key)
    
        try:
            self.repository.add_user(username, salt, verifier)
            logger.info(f"User '{username}' registered successfully.")
            return True
        except Exception as e:
            logger.error(f"Registration failed for user '{username}': {e}")
>           raise SaveLinksError("Registration failed. Username might be taken.")
E           src.core.exceptions.SaveLinksError: Registration failed. Username might be taken.

src\service\link_service.py:27: SaveLinksError
---------------------------- Captured stderr call -----------------------------
2026-02-11 20:03:47,019 - SaveLinks - ERROR - Failed to add user: no such table: users
2026-02-11 20:03:47,019 - SaveLinks - ERROR - Registration failed for user 'user3': Failed to add user.
------------------------------ Captured log call ------------------------------
ERROR    SaveLinks:repository.py:67 Failed to add user: no such table: users
ERROR    SaveLinks:link_service.py:26 Registration failed for user 'user3': Failed to add user.
___________________________ test_search_no_results ____________________________

self = <src.database.repository.LinkRepository object at 0x00000226A2BDAB10>
username = 'user4', salt = b'3\x90a$0]d\x90\xb8\x16\xf5\xa3Rs\x9f6'
verifier = b'\xe0\\\xec+\x00\xc5\xc0g\x1dG\xfeM^^ \xad3\xaf\x82\xcc\xbc\xe3\xde\xa7\xf5V1\xa8\x8f\xf9\x8d\x93'

    def add_user(self, username: str, salt: bytes, verifier: bytes) -> int:
        """Adds a new user to the database."""
        try:
            with self._get_connection() as conn:
                cursor = conn.cursor()
>               cursor.execute(
                    "INSERT INTO users (username, salt, verifier) VALUES (?, ?, ?)",
                    (username, salt, verifier)
                )
E               sqlite3.OperationalError: no such table: users

src\database\repository.py:58: OperationalError

The above exception was the direct cause of the following exception:

self = <src.service.link_service.LinkService object at 0x00000226A2BDB6F0>
username = 'user4', password = 'pass'

    def register_user(self, username, password):
        """Registers a new user."""
        if not username or not password:
            raise ValidationError("Username and password cannot be empty.")
    
        salt = SecurityManager.generate_salt()
        key = SecurityManager.derive_key(password, salt)
        verifier = SecurityManager.hash_key(key)
    
        try:
>           self.repository.add_user(username, salt, verifier)

src\service\link_service.py:22: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <src.database.repository.LinkRepository object at 0x00000226A2BDAB10>
username = 'user4', salt = b'3\x90a$0]d\x90\xb8\x16\xf5\xa3Rs\x9f6'
verifier = b'\xe0\\\xec+\x00\xc5\xc0g\x1dG\xfeM^^ \xad3\xaf\x82\xcc\xbc\xe3\xde\xa7\xf5V1\xa8\x8f\xf9\x8d\x93'

    def add_user(self, username: str, salt: bytes, verifier: bytes) -> int:
        """Adds a new user to the database."""
        try:
            with self._get_connection() as conn:
                cursor = conn.cursor()
                cursor.execute(
                    "INSERT INTO users (username, salt, verifier) VALUES (?, ?, ?)",
                    (username, salt, verifier)
                )
                conn.commit()
                return cursor.lastrowid
        except sqlite3.IntegrityError:
            raise DatabaseError("User already exists.")
        except sqlite3.Error as e:
            logger.error(f"Failed to add user: {e}")
>           raise DatabaseError("Failed to add user.") from e
E           src.core.exceptions.DatabaseError: Failed to add user.

src\database\repository.py:68: DatabaseError

During handling of the above exception, another exception occurred:

service = <src.service.link_service.LinkService object at 0x00000226A2BDB6F0>

    def test_search_no_results(service):
>       service.register_user("user4", "pass")

tests\test_service.py:42: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <src.service.link_service.LinkService object at 0x00000226A2BDB6F0>
username = 'user4', password = 'pass'

    def register_user(self, username, password):
        """Registers a new user."""
        if not username or not password:
            raise ValidationError("Username and password cannot be empty.")
    
        salt = SecurityManager.generate_salt()
        key = SecurityManager.derive_key(password, salt)
        verifier = SecurityManager.hash_key(key)
    
        try:
            self.repository.add_user(username, salt, verifier)
            logger.info(f"User '{username}' registered successfully.")
            return True
        except Exception as e:
            logger.error(f"Registration failed for user '{username}': {e}")
>           raise SaveLinksError("Registration failed. Username might be taken.")
E           src.core.exceptions.SaveLinksError: Registration failed. Username might be taken.

src\service\link_service.py:27: SaveLinksError
---------------------------- Captured stderr call -----------------------------
2026-02-11 20:03:47,043 - SaveLinks - ERROR - Failed to add user: no such table: users
2026-02-11 20:03:47,043 - SaveLinks - ERROR - Registration failed for user 'user4': Failed to add user.
------------------------------ Captured log call ------------------------------
ERROR    SaveLinks:repository.py:67 Failed to add user: no such table: users
ERROR    SaveLinks:link_service.py:26 Registration failed for user 'user4': Failed to add user.
______________________________ test_delete_link _______________________________

self = <src.database.repository.LinkRepository object at 0x00000226A2BDB950>
username = 'user5', salt = b'\x9a\xcb\x11\x06\xce\x97\x06\xb0*k\xa5!\n\xf7@\t'
verifier = b'z]\xa4\x15=\xf7\xc5\x8b\xdf\x8f\x97\x1b\x153dL\xa8\xb2\xa8\x07G7d\xeb\xb4\xf0\x95\xec\x0b/\x0b\xef'

    def add_user(self, username: str, salt: bytes, verifier: bytes) -> int:
        """Adds a new user to the database."""
        try:
            with self._get_connection() as conn:
                cursor = conn.cursor()
>               cursor.execute(
                    "INSERT INTO users (username, salt, verifier) VALUES (?, ?, ?)",
                    (username, salt, verifier)
                )
E               sqlite3.OperationalError: no such table: users

src\database\repository.py:58: OperationalError

The above exception was the direct cause of the following exception:

self = <src.service.link_service.LinkService object at 0x00000226A2BDB820>
username = 'user5', password = 'pass'

    def register_user(self, username, password):
        """Registers a new user."""
        if not username or not password:
            raise ValidationError("Username and password cannot be empty.")
    
        salt = SecurityManager.generate_salt()
        key = SecurityManager.derive_key(password, salt)
        verifier = SecurityManager.hash_key(key)
    
        try:
>           self.repository.add_user(username, salt, verifier)

src\service\link_service.py:22: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <src.database.repository.LinkRepository object at 0x00000226A2BDB950>
username = 'user5', salt = b'\x9a\xcb\x11\x06\xce\x97\x06\xb0*k\xa5!\n\xf7@\t'
verifier = b'z]\xa4\x15=\xf7\xc5\x8b\xdf\x8f\x97\x1b\x153dL\xa8\xb2\xa8\x07G7d\xeb\xb4\xf0\x95\xec\x0b/\x0b\xef'

    def add_user(self, username: str, salt: bytes, verifier: bytes) -> int:
        """Adds a new user to the database."""
        try:
            with self._get_connection() as conn:
                cursor = conn.cursor()
                cursor.execute(
                    "INSERT INTO users (username, salt, verifier) VALUES (?, ?, ?)",
                    (username, salt, verifier)
                )
                conn.commit()
                return cursor.lastrowid
        except sqlite3.IntegrityError:
            raise DatabaseError("User already exists.")
        except sqlite3.Error as e:
            logger.error(f"Failed to add user: {e}")
>           raise DatabaseError("Failed to add user.") from e
E           src.core.exceptions.DatabaseError: Failed to add user.

src\database\repository.py:68: DatabaseError

During handling of the above exception, another exception occurred:

service = <src.service.link_service.LinkService object at 0x00000226A2BDB820>

    def test_delete_link(service):
>       service.register_user("user5", "pass")

tests\test_service.py:49: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <src.service.link_service.LinkService object at 0x00000226A2BDB820>
username = 'user5', password = 'pass'

    def register_user(self, username, password):
        """Registers a new user."""
        if not username or not password:
            raise ValidationError("Username and password cannot be empty.")
    
        salt = SecurityManager.generate_salt()
        key = SecurityManager.derive_key(password, salt)
        verifier = SecurityManager.hash_key(key)
    
        try:
            self.repository.add_user(username, salt, verifier)
            logger.info(f"User '{username}' registered successfully.")
            return True
        except Exception as e:
            logger.error(f"Registration failed for user '{username}': {e}")
>           raise SaveLinksError("Registration failed. Username might be taken.")
E           src.core.exceptions.SaveLinksError: Registration failed. Username might be taken.

src\service\link_service.py:27: SaveLinksError
---------------------------- Captured stderr call -----------------------------
2026-02-11 20:03:47,067 - SaveLinks - ERROR - Failed to add user: no such table: users
2026-02-11 20:03:47,068 - SaveLinks - ERROR - Registration failed for user 'user5': Failed to add user.
------------------------------ Captured log call ------------------------------
ERROR    SaveLinks:repository.py:67 Failed to add user: no such table: users
ERROR    SaveLinks:link_service.py:26 Registration failed for user 'user5': Failed to add user.
=========================== short test summary info ===========================
FAILED tests/test_service.py::test_register_login - src.core.exceptions.SaveL...
FAILED tests/test_service.py::test_login_invalid_password - src.core.exceptio...
FAILED tests/test_service.py::test_add_search_link - src.core.exceptions.Save...
FAILED tests/test_service.py::test_search_no_results - src.core.exceptions.Sa...
FAILED tests/test_service.py::test_delete_link - src.core.exceptions.SaveLink...
========================= 5 failed, 4 passed in 0.31s =========================
